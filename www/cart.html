<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <link rel="stylesheet" href="components/loader.css">
    <script src="components/loader.js"></script>
    <script src="keys.js"></script>
    <title>MystiCo - ã‚«ãƒ¼ãƒˆ</title>
    <link rel="stylesheet" href="css/cart.css">
</head>
<body>
    <header class="header">
        <h1>MystiCo</h1>
    </header>

    <div class="cart-container">
        <a href="index.html" class="back-button">ï¼œ Home</a>
        <table id="cart-table">
            <thead>
                <tr>
                    <th>å•†å“å</th>
                    <th>æ•°é‡</th>
                    <th>å°è¨ˆé‡‘é¡</th>
                    <th>å‰Šé™¤</th>
                </tr>
            </thead>
            <tbody>
                <!-- å•†å“ã®è¡Œã¯JavaScriptã§è¿½åŠ  -->
            </tbody>
        </table>
        <!-- <div class="total-container">
            <span>åˆè¨ˆé‡‘é¡: </span>
            <span id="total-price">Â¥0</span>
        </div> -->
        <button class="purchase-btn">è³¼å…¥ã™ã‚‹</button>
    </div>

    <script>
        let ncmb = new NCMB(appKey, clientKey); // Initialize NIFCLOUD
        let Cart = ncmb.DataStore("Cart");

        function fetchCartItems() {
    Cart.fetchAll()
        .then(function(results){
            let table = document.getElementById('cart-table');
            let tbody = table.getElementsByTagName('tbody')[0]; // tbodyè¦ç´ ã‚’å–å¾—
            tbody.innerHTML = ''; // Clear the tbody content

            let total = 0;
            results.forEach(function(item){
                let row = tbody.insertRow();
                row.insertCell().textContent = item.get("productName");
                row.insertCell().textContent = item.get("quantity");
                let subtotal = item.get("subtotal");
                row.insertCell().textContent = 'Â¥' + subtotal;
                total += subtotal;

                // Add delete button
                let deleteCell = row.insertCell();
                let deleteButton = document.createElement('button');
                deleteButton.textContent = 'ğŸ—‘';
                deleteButton.onclick = function(){
                    // Delete this item
                    item.delete()
                        .then(function(){
                            // Refresh the cart items
                            fetchCartItems();
                        })
                        .catch(function(err){
                            alert('Failed to delete item: ' + err);
                        });
                };
                deleteCell.appendChild(deleteButton);
            });
            // Display total
            let totalRow = tbody.insertRow();
            totalRow.insertCell().textContent = 'åˆè¨ˆé‡‘é¡';
            totalRow.insertCell().setAttribute('colspan', '2');
            totalRow.insertCell().textContent = 'Â¥' + total;
        })
        .catch(function(err){
            alert('Failed to fetch cart items: ' + err);
        });
}

// è³¼å…¥ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«å‡¦ç†ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
        fetchCartItems();

        let purchaseBtn = document.querySelector('.purchase-btn');
        purchaseBtn.addEventListener('click', function() {
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤º
            let confirmPurchase = confirm('è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ');
            if (confirmPurchase) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã¯ã„ã€ã‚’é¸æŠã—ãŸå ´åˆã®å‡¦ç†
                Cart.fetchAll()
                    .then(function(results){
                        // ã‚«ãƒ¼ãƒˆå†…ã®å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
                        Promise.all(results.map(item => item.delete()))
                            .then(function() {
                                fetchCartItems(); // ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
                                // index.htmlã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                                window.location.href = 'index.html';
                            })
                            .catch(function(error) {
                                alert('å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                            });
                    })
                    .catch(function(error) {
                        alert('ã‚«ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                    });
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã—ãŸå ´åˆã®å‡¦ç†
                // ä½•ã‚‚ã—ãªã„
            }
        });
    });


        // Load cart items when page is loaded
        document.addEventListener('DOMContentLoaded', fetchCartItems);
    </script>
</body>
</html>